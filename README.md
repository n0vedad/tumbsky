# Tumbsky

A Tumblr-style Bluesky client with custom CSS styling for your posts.

## What is Tumbsky?

Tumbsky allows you to display your Bluesky posts on a personalized page with custom CSS styling,
similar to how Tumblr blogs work. Each user gets their own customizable page where they can style
their posts however they want.

### Features

- ğŸ” **OAuth Login** with your Bluesky account
- ğŸ“ **Display your posts** in a clean, customizable format
- ğŸ¨ **Custom CSS** - Style your posts however you want
- ğŸ”— **Personal URL** - Share your styled page (e.g., `tumbsky.app/@yourhandle`)
- âš¡ **Live updates** - New posts appear automatically via Firehose

### What Tumbsky is NOT (for now)

- âŒ Not a full Bluesky client (no posting, liking, or replying)
- âŒ No timeline with mixed posts from multiple users
- âŒ No direct messages or notifications

Posts are created on bsky.app and displayed beautifully on Tumbsky.

## Tech Stack

- **Frontend**: SvelteKit + TypeScript
- **Backend**: SvelteKit (SSR)
- **Database**: libSQL/SQLite with Drizzle ORM
- **ATProto**: @atcute/* libraries
- **Real-time**: Tap (ATProto Firehose)
- **Deployment**: Railway

Based on the [atcute-statusphere-example](https://github.com/mary-ext/atcute-statusphere-example).

## Local Development

### Prerequisites

- Node.js 20+
- pnpm 10+
- A public HTTPS URL (via tunnel or your own server)

### Quick Start

1. **Clone and install:**
   ```sh
   git clone https://github.com/yourusername/tumbsky.git
   cd tumbsky
   pnpm install
   ```

2. **Run the dev script:**
   ```sh
   pnpm dev
   ```

   The `dev.sh` script will:
   - Create `.env` if it doesn't exist
   - Generate OAuth keys (`OAUTH_PRIVATE_KEY_JWK`, `COOKIE_SECRET`) via `pnpm env:setup`
   - Check if `OAUTH_PUBLIC_URL` is configured
   - Provide instructions for setting up a tunnel if needed
   - Start the Vite dev server

3. **Set up a tunnel (if needed):**

   OAuth requires a public HTTPS URL. Choose one of these options:

   **Option A: Cloudflared**
   ```sh
   cloudflared tunnel --url http://localhost:5173
   ```
   Copy the `https://` URL and add it to `.env`:
   ```sh
   OAUTH_PUBLIC_URL=https://your-random-url.trycloudflare.com
   ```

   **Option B: ngrok**
   ```sh
   ngrok http 5173
   ```
   Copy the `https://` URL and add it to `.env`:
   ```sh
   OAUTH_PUBLIC_URL=https://your-id.ngrok.io
   ```

   **Option C: Your own server**
   - Set up a reverse proxy with nginx/caddy
   - Configure SSL with Let's Encrypt
   - Point `OAUTH_PUBLIC_URL` to your domain

4. **Access Tumbsky:**
   - Visit your `OAUTH_PUBLIC_URL`
   - Log in with your Bluesky account

### OAuth Metadata Hosting

ATProto OAuth requires serving two files publicly:
- `${OAUTH_PUBLIC_URL}/oauth-client-metadata.json`
- `${OAUTH_PUBLIC_URL}/jwks.json`

**These are served automatically** by SvelteKit routes:
- [`/oauth-client-metadata.json/+server.ts`](src/routes/oauth-client-metadata.json/+server.ts)
- [`/jwks.json/+server.ts`](src/routes/jwks.json/+server.ts)

No external hosting needed!

### Environment Variables

After running `pnpm dev`, your `.env` will contain:

```sh
# Database Configuration
DATABASE_URL=file:local.db

# OAuth Configuration (auto-generated by pnpm env:setup)
OAUTH_PUBLIC_URL=https://your-tunnel-url.example.com
OAUTH_PRIVATE_KEY_JWK={"kty":"EC","crv":"P-256",...}
COOKIE_SECRET=random-secret

# Optional: Tap/Firehose for real-time updates
# TAP_URL=http://localhost:2480
# TAP_ADMIN_PASSWORD=
```

### Database

- `pnpm db:push` - Push schema changes to database
- `pnpm db:generate` - Generate migration files
- `pnpm db:migrate` - Run migrations
- `pnpm db:studio` - Open Drizzle Studio

### Code Quality

- `pnpm check` - Type checking with Svelte
- `pnpm format` - Format code with Prettier
- `pnpm lint` - Check code formatting

## Production Deployment (Railway)

### Prerequisites

- [Railway account](https://railway.app)
- [Turso database](https://turso.tech) (optional, or use local SQLite)

### Deploy to Railway

1. **Create a new Railway project:**
   - Click "Deploy from GitHub repo"
   - Select your Tumbsky repository

2. **Configure environment variables:**

   In Railway's dashboard, add:
   ```sh
   # Database (if using Turso)
   DATABASE_URL=libsql://your-db.turso.io
   TURSO_AUTH_TOKEN=your-turso-token

   # OAuth (generate locally with pnpm env:setup)
   OAUTH_PRIVATE_KEY_JWK={"kty":"EC","crv":"P-256",...}
   COOKIE_SECRET=random-secret-here

   # Public URL (Railway provides this automatically)
   OAUTH_PUBLIC_URL=https://your-app.up.railway.app
   ```

3. **Deploy:**
   - Railway will automatically detect the build configuration from `railway.json`
   - The app will build and deploy automatically
   - OAuth metadata will be served automatically at:
     - `https://your-app.up.railway.app/oauth-client-metadata.json`
     - `https://your-app.up.railway.app/jwks.json`

4. **Run database migrations:**
   ```sh
   # From your local machine, with Turso credentials
   DATABASE_URL=libsql://your-db.turso.io \
   TURSO_AUTH_TOKEN=your-token \
   pnpm db:push
   ```

### Railway Configuration

The `railway.json` file configures:
- Build command: `pnpm build`
- Start command: `node build/index.js`
- Node version: 20.x

### Using Turso Database

1. Create a Turso database:
   ```sh
   turso db create tumbsky
   turso db show tumbsky
   ```

2. Get the connection details:
   ```sh
   turso db show tumbsky --url
   turso db tokens create tumbsky
   ```

3. Add to Railway environment variables:
   ```sh
   DATABASE_URL=libsql://your-db.turso.io
   TURSO_AUTH_TOKEN=your-token
   ```

## Project Structure

```
tumbsky/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”œâ”€â”€ assets/          # SVG logos, images
â”‚   â”‚   â”œâ”€â”€ components/      # Svelte components
â”‚   â”‚   â”‚   â”œâ”€â”€ header.svelte
â”‚   â”‚   â”‚   â”œâ”€â”€ post-card.svelte
â”‚   â”‚   â”‚   â””â”€â”€ post-list.svelte
â”‚   â”‚   â”œâ”€â”€ server/          # Server-side code
â”‚   â”‚   â”‚   â”œâ”€â”€ auth/        # Session validation, cookie signing
â”‚   â”‚   â”‚   â”œâ”€â”€ db/          # Drizzle schema, client, migrations
â”‚   â”‚   â”‚   â”œâ”€â”€ oauth/       # OAuth client setup & stores
â”‚   â”‚   â”‚   â”œâ”€â”€ posts/       # Post fetching & syncing
â”‚   â”‚   â”‚   â”œâ”€â”€ users/       # User management
â”‚   â”‚   â”‚   â”œâ”€â”€ tap/         # Firehose integration
â”‚   â”‚   â”‚   â””â”€â”€ css-sanitizer.ts
â”‚   â”‚   â””â”€â”€ types.ts         # TypeScript types
â”‚   â”œâ”€â”€ routes/              # SvelteKit routes
â”‚   â”‚   â”œâ”€â”€ +page.svelte     # Homepage
â”‚   â”‚   â”œâ”€â”€ @[handle]/       # User profile pages
â”‚   â”‚   â”œâ”€â”€ settings/        # CSS editor
â”‚   â”‚   â”œâ”€â”€ login/           # OAuth login
â”‚   â”‚   â”œâ”€â”€ oauth/callback/  # OAuth callback
â”‚   â”‚   â”œâ”€â”€ oauth-client-metadata.json/  # OAuth metadata endpoint
â”‚   â”‚   â”œâ”€â”€ jwks.json/       # JWKS endpoint
â”‚   â”‚   â””â”€â”€ api/             # API endpoints
â”‚   â””â”€â”€ hooks.server.ts      # Session handling & migrations
â”œâ”€â”€ drizzle/                 # Database migrations
â”‚   â”œâ”€â”€ 0000_initial_oauth_tables.sql
â”‚   â”œâ”€â”€ 0001_initial_users_and_posts_tables.sql
â”‚   â””â”€â”€ 0002_add_posts_indexes.sql
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ dev.sh               # Development setup script
â”‚   â””â”€â”€ setup-env.mjs        # Environment setup
â”œâ”€â”€ railway.json             # Railway deployment config
â””â”€â”€ .env.example             # Environment template
```

## License

MIT

## Acknowledgments

- Built with [atcute](https://github.com/mary-ext/atcute) by Mary
- Based on [atcute-statusphere-example](https://github.com/mary-ext/atcute-statusphere-example)
- Inspired by Tumblr's customizable blogs
